{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Results - StudyPro</title>
    <link rel="stylesheet" href="{% static 'css/style.css' %}">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
            padding: 20px; 
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .container { max-width: 700px; width: 100%; }
        .email-preview { background: #fff; border-radius: 12px; box-shadow: 0 20px 60px rgba(0,0,0,0.15); overflow: hidden; }
        .header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: #fff; padding: 40px 20px; text-align: center; }
        .header h1 { font-size: 28px; margin-bottom: 8px; font-weight: 700; }
        .header p { font-size: 14px; opacity: 0.95; }
        .content { padding: 40px 30px; }
        .greeting { font-size: 16px; color: #1a202c; margin-bottom: 8px; }
        .greeting strong { color: #667eea; }
        .subtext { font-size: 14px; color: #718096; margin-bottom: 30px; }
        .results-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin: 30px 0; }
        .result-box { background: #f7fafc; border-left: 4px solid #667eea; padding: 20px; border-radius: 8px; }
        .result-label { font-size: 12px; color: #718096; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 8px; }
        .result-value { font-size: 24px; font-weight: 700; color: #2d3748; }
        .result-value.high { color: #48bb78; }
        .result-value.medium { color: #ed8936; }
        .result-value.low { color: #f56565; }
        .status-badge { display: inline-block; margin-top: 20px; padding: 12px 24px; border-radius: 50px; font-weight: 700; font-size: 16px; text-align: center; }
        .status-badge.pass { background: #c6f6d5; color: #22543d; }
        .status-badge.fail { background: #fed7d7; color: #742a2a; }
        .feedback-section { background: #edf2f7; padding: 20px; border-radius: 8px; margin: 25px 0; }
        .feedback-label { font-size: 12px; color: #4a5568; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 10px; }
        .feedback-text { font-size: 14px; color: #2d3748; line-height: 1.6; }
        .divider { border-top: 1px solid #e2e8f0; margin: 25px 0; }
        .footer { background: #f7fafc; padding: 20px 30px; text-align: center; font-size: 12px; color: #718096; }
        .footer-text { margin: 5px 0; }
        .footer-brand { font-weight: 700; color: #667eea; }
        .action-section { margin-top: 30px; display: flex; gap: 12px; justify-content: center; flex-wrap: wrap; }
        .btn { padding: 12px 30px; border-radius: 8px; font-weight: 700; text-decoration: none; border: none; cursor: pointer; transition: all 0.3s; font-size: 14px; }
        .btn-primary { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: #fff; }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3); }
        .btn-secondary { background: #e2e8f0; color: #2d3748; }
        .btn-secondary:hover { background: #cbd5e0; }
        .status-bar { display: flex; align-items: center; justify-content: space-between; gap: 20px; margin-top: 20px; padding-top: 20px; border-top: 1px solid #e2e8f0; }
        .status-item { display: flex; align-items: center; gap: 8px; font-size: 13px; }
        .status-icon { width: 24px; height: 24px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 12px; }
        .icon-check { background: #c6f6d5; color: #22543d; }
        .icon-loading { background: #fef3c7; color: #78350f; animation: pulse 1.5s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        .icon-done { background: #c6f6d5; color: #22543d; }
        @media (max-width: 600px) {
            .results-grid { grid-template-columns: 1fr; }
            .header h1 { font-size: 24px; }
            .content { padding: 25px 20px; }
            .action-section { flex-direction: column; }
            .btn { width: 100%; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="email-preview">
            <div class="header">
                <h1>üéØ Test Results</h1>
                <p id="testName">Your Test Results</p>
            </div>
            
            <div class="content">
                <div class="greeting">Hi <strong id="userName">Candidate</strong>,</div>
                <p class="subtext">Your test has been evaluated. Here's your detailed performance report:</p>
                
                <div class="results-grid">
                    <div class="result-box">
                        <div class="result-label">üìä Score</div>
                        <div class="result-value" id="scoreDisplay">0/20</div>
                    </div>
                    <div class="result-box">
                        <div class="result-label">‚úÖ Accuracy</div>
                        <div class="result-value" id="accuracyDisplay">0%</div>
                    </div>
                    <div class="result-box">
                        <div class="result-label">‚è±Ô∏è Time Taken</div>
                        <div class="result-value" id="timeDisplay">--:--</div>
                    </div>
                    <div class="result-box">
                        <div class="result-label">üèÜ Rank</div>
                        <div class="result-value" id="rankDisplay">N/A</div>
                    </div>
                </div>

                <div style="text-align: center;">
                    <div class="status-badge" id="statusBadge">‚úÖ PASSED</div>
                </div>

                <div class="divider"></div>

                <div class="feedback-section">
                    <div class="feedback-label">üí° Feedback</div>
                    <div class="feedback-text" id="feedbackText">Loading feedback...</div>
                </div>

                <div class="status-bar">
                    <div class="status-item">
                        <div class="status-icon icon-done">‚úì</div>
                        <span>Results Generated</span>
                    </div>
                    <div class="status-item">
                        <div class="status-icon icon-loading" id="emailStatus">üìß</div>
                        <span id="emailStatusText">Sending email...</span>
                    </div>
                    <div class="status-item">
                        <div class="status-icon icon-loading" id="saveStatus">üíæ</div>
                        <span id="saveStatusText">Saving to profile...</span>
                    </div>
                    <div class="status-item">
                        <div class="status-icon" id="redirectStatus">‚Üí</div>
                        <span id="redirectStatusText">Redirecting...</span>
                    </div>
                </div>

                <div class="action-section">
                    <button class="btn btn-secondary" id="deleteResultBtn" onclick="deleteResult()">üóëÔ∏è Remove from Profile</button>
                    <a href="/dashboard/" class="btn btn-primary">Go to Dashboard</a>
                </div>
            </div>

            <div class="footer">
                <div class="footer-text">Thank you for using <span class="footer-brand">StudyPro</span></div>
                <div class="footer-text" style="margin-top: 10px; opacity: 0.8;">¬© 2025 StudyPro. All rights reserved.</div>
            </div>
        </div>
    </div>

    <script>
        // Delete result from user profile
        async function deleteResult() {
            try {
                const resultData = JSON.parse(sessionStorage.getItem('testResult') || '{}');
                
                if (!resultData || !resultData.timestamp) {
                    alert('No result found to delete');
                    return;
                }

                if (!confirm('Are you sure you want to delete this result from your profile? This cannot be undone.')) {
                    return;
                }

                const deleteBtn = document.getElementById('deleteResultBtn');
                deleteBtn.disabled = true;
                deleteBtn.textContent = '‚è≥ Removing...';

                const response = await fetch('/api/delete-test-result/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCsrfToken()
                    },
                    body: JSON.stringify({ timestamp: resultData.timestamp })
                });

                const json = await response.json();

                if (response.ok && json.ok) {
                    deleteBtn.textContent = '‚úÖ Removed';
                    deleteBtn.style.background = '#f56565';
                    showNotification('Result removed from your profile!', 'success');
                    setTimeout(() => {
                        window.location.href = '/dashboard/';
                    }, 2000);
                } else {
                    throw new Error(json.error || 'Failed to delete');
                }
            } catch (error) {
                console.error('Delete error:', error);
                alert('Failed to remove result: ' + error.message);
                document.getElementById('deleteResultBtn').disabled = false;
                document.getElementById('deleteResultBtn').textContent = 'üóëÔ∏è Remove from Profile';
            }
        }

        // Helper to get CSRF token
        function getCsrfToken() {
            const name = 'csrftoken';
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let cookie of cookies) {
                    cookie = cookie.trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        // Show notification
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: ${type === 'success' ? '#48bb78' : '#3182ce'};
                color: white;
                padding: 16px 24px;
                border-radius: 8px;
                z-index: 9999;
                font-weight: 600;
                animation: slideIn 0.3s ease;
            `;
            notification.textContent = message;
            document.body.appendChild(notification);
            setTimeout(() => notification.remove(), 4000);
        }

        // Add CSS animation
        const style = document.createElement('style');
        style.textContent = `
            @keyframes slideIn {
                from { transform: translateX(400px); opacity: 0; }
                to { transform: translateX(0); opacity: 1; }
            }
        `;
        document.head.appendChild(style);

        // Initialize and display results
        (async function() {
            try {
                // Get result data from sessionStorage
                const resultData = JSON.parse(sessionStorage.getItem('testResult') || '{}');
                
                if (!resultData || !resultData.email) {
                    console.error('No result data found');
                    setTimeout(() => window.location.href = '/dashboard/', 2000);
                    return;
                }

                // Populate the page with result data
                document.getElementById('userName').textContent = resultData.name || 'Candidate';
                document.getElementById('testName').textContent = resultData.test_name || 'Test Results';
                document.getElementById('scoreDisplay').textContent = `${resultData.correct}/${resultData.total_questions}`;
                document.getElementById('accuracyDisplay').textContent = `${resultData.percentage}%`;
                document.getElementById('timeDisplay').textContent = resultData.time_taken || '--:--';
                document.getElementById('rankDisplay').textContent = resultData.rank || 'N/A';
                document.getElementById('feedbackText').textContent = resultData.feedback || 'Keep practicing!';

                // Set status badge color based on pass/fail
                const statusBadge = document.getElementById('statusBadge');
                if (resultData.percentage >= 70) {
                    statusBadge.className = 'status-badge pass';
                    statusBadge.textContent = '‚úÖ PASSED';
                } else {
                    statusBadge.className = 'status-badge fail';
                    statusBadge.textContent = '‚ùå NEEDS IMPROVEMENT';
                }

                // Set accuracy color
                const accuracyDisplay = document.getElementById('accuracyDisplay');
                const acc = parseFloat(resultData.percentage);
                if (acc >= 80) {
                    accuracyDisplay.className = 'result-value high';
                } else if (acc >= 60) {
                    accuracyDisplay.className = 'result-value medium';
                } else {
                    accuracyDisplay.className = 'result-value low';
                }

                // Send email via EmailJS and notify about auto-save
                setTimeout(async () => {
                    try {
                        const SERVICE_ID = localStorage.getItem('emailjs_service_id') || 'service_ezhr476';
                        const TEMPLATE_ID = localStorage.getItem('emailjs_template_id') || 'template_45wwzh7';
                        const USER_ID = localStorage.getItem('emailjs_user_id') || 'qj6a6uFf7_8k-lBpF';

                        if (!window.emailjs) {
                            throw new Error('EmailJS not loaded');
                        }

                        if (!window.emailjs_initialized) {
                            window.emailjs.init(USER_ID);
                            window.emailjs_initialized = true;
                        }

                        // Build email parameters
                        const templateParams = {
                            to_email: resultData.email,
                            from_name: resultData.name || 'Test Candidate',
                            message: `Test Result Report\n\nCompany: ${resultData.company || 'N/A'}\nDifficulty: ${resultData.difficulty || 'N/A'}\n\nScore: ${resultData.correct} / ${resultData.total_questions}\nAccuracy: ${resultData.percentage}%\nStatus: ${resultData.percentage >= 70 ? 'PASSED' : 'NEEDS IMPROVEMENT'}\n\n${resultData.feedback || ''}`
                        };

                        // Send email
                        const response = await window.emailjs.send(SERVICE_ID, TEMPLATE_ID, templateParams);
                        
                        if (response.status === 200) {
                            // Email sent successfully
                            document.getElementById('emailStatus').className = 'status-icon icon-done';
                            document.getElementById('emailStatus').textContent = '‚úì';
                            document.getElementById('emailStatusText').textContent = 'Email sent to ' + resultData.email;
                        }
                    } catch (emailErr) {
                        console.error('Email sending error:', emailErr);
                        document.getElementById('emailStatus').className = 'status-icon';
                        document.getElementById('emailStatus').style.background = '#fed7d7';
                        document.getElementById('emailStatus').style.color = '#742a2a';
                        document.getElementById('emailStatus').textContent = '‚úó';
                        document.getElementById('emailStatusText').textContent = 'Email could not be sent';
                    }

                    // Update save status (result was auto-saved in backend)
                    document.getElementById('saveStatus').className = 'status-icon icon-done';
                    document.getElementById('saveStatus').textContent = '‚úì';
                    document.getElementById('saveStatusText').textContent = 'Saved to your profile';

                    // Redirect after 4 seconds
                    setTimeout(() => {
                        document.getElementById('redirectStatus').className = 'status-icon icon-done';
                        document.getElementById('redirectStatus').textContent = '‚úì';
                        document.getElementById('redirectStatusText').textContent = 'Redirecting to dashboard...';
                        
                        setTimeout(() => {
                            sessionStorage.removeItem('testResult');
                            window.location.href = '/dashboard/';
                        }, 1000);
                    }, 4000);

                }, 500);

            } catch (error) {
                console.error('Error:', error);
                setTimeout(() => window.location.href = '/dashboard/', 3000);
            }
        })();
    </script>
</body>
</html>
