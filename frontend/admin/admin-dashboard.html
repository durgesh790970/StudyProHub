<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - StudyHub Coding Contest</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f5f5f5;
            color: #333;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .header h1 {
            font-size: 28px;
            margin-bottom: 5px;
        }

        .header p {
            font-size: 14px;
            opacity: 0.9;
        }

        .container {
            max-width: 1400px;
            margin: 30px auto;
            padding: 0 20px;
        }

        .nav-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            border-bottom: 2px solid #e0e0e0;
        }

        .nav-tabs button {
            background: none;
            border: none;
            padding: 15px 25px;
            font-size: 16px;
            cursor: pointer;
            color: #666;
            transition: all 0.3s;
            border-bottom: 3px solid transparent;
        }

        .nav-tabs button.active {
            color: #667eea;
            border-bottom-color: #667eea;
        }

        .nav-tabs button:hover {
            color: #667eea;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            transition: transform 0.3s, box-shadow 0.3s;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
        }

        .stat-card .label {
            font-size: 14px;
            color: #999;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 10px;
        }

        .stat-card .value {
            font-size: 32px;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 10px;
        }

        .stat-card .change {
            font-size: 13px;
            color: #27ae60;
        }

        .stat-card .change.negative {
            color: #e74c3c;
        }

        .action-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 30px 0;
        }

        .action-btn {
            background: white;
            border: 2px solid #e0e0e0;
            padding: 25px;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
            text-decoration: none;
            color: inherit;
        }

        .action-btn:hover {
            border-color: #667eea;
            background: #f8f9ff;
            transform: translateY(-3px);
        }

        .action-btn .icon {
            font-size: 32px;
            margin-bottom: 10px;
        }

        .action-btn .title {
            font-size: 16px;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .action-btn .desc {
            font-size: 12px;
            color: #999;
        }

        .table-section {
            background: white;
            border-radius: 10px;
            padding: 25px;
            margin: 30px 0;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }

        .table-section h2 {
            margin-bottom: 20px;
            color: #333;
            font-size: 20px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        thead {
            background: #f5f5f5;
        }

        th {
            padding: 15px;
            text-align: left;
            font-weight: 600;
            color: #666;
            border-bottom: 2px solid #e0e0e0;
        }

        td {
            padding: 15px;
            border-bottom: 1px solid #e0e0e0;
        }

        tr:hover {
            background: #f9f9f9;
        }

        .badge {
            display: inline-block;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }

        .badge.success {
            background: #d4edda;
            color: #155724;
        }

        .badge.warning {
            background: #fff3cd;
            color: #856404;
        }

        .badge.danger {
            background: #f8d7da;
            color: #721c24;
        }

        .badge.info {
            background: #d1ecf1;
            color: #0c5460;
        }

        .action-icons {
            display: flex;
            gap: 10px;
        }

        .action-icons button {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 18px;
            color: #667eea;
            transition: all 0.3s;
        }

        .action-icons button:hover {
            transform: scale(1.2);
        }

        .action-icons button.delete:hover {
            color: #e74c3c;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 10px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 20px;
            color: #333;
        }

        .close-btn {
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            color: #999;
        }

        .close-btn:hover {
            color: #333;
        }

        .chart-container {
            background: white;
            padding: 25px;
            border-radius: 10px;
            margin: 30px 0;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }

        .chart-container h3 {
            margin-bottom: 20px;
            color: #333;
        }

        .btn {
            display: inline-block;
            padding: 10px 20px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
            text-decoration: none;
        }

        .btn:hover {
            background: #764ba2;
            transform: translateY(-2px);
        }

        .btn.secondary {
            background: #e0e0e0;
            color: #333;
        }

        .btn.secondary:hover {
            background: #d0d0d0;
        }

        .btn.small {
            padding: 6px 12px;
            font-size: 12px;
        }

        .search-box {
            margin-bottom: 20px;
            display: flex;
            gap: 10px;
        }

        .search-box input,
        .search-box select {
            padding: 10px 15px;
            border: 1px solid #e0e0e0;
            border-radius: 5px;
            font-size: 14px;
        }

        .search-box input {
            flex: 1;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        @media (max-width: 768px) {
            .stats-grid {
                grid-template-columns: 1fr;
            }

            .header h1 {
                font-size: 20px;
            }

            .table-section {
                overflow-x: auto;
            }

            .nav-tabs {
                flex-wrap: wrap;
            }

            .nav-tabs button {
                padding: 10px 15px;
                font-size: 14px;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üìä Admin Dashboard</h1>
        <p>Platform Management & Statistics</p>
    </div>

    <div class="container">
        <!-- Navigation Tabs -->
        <div class="nav-tabs">
            <button class="tab-btn active" data-tab="overview">Overview</button>
            <button class="tab-btn" data-tab="problems">Problems</button>
            <button class="tab-btn" data-tab="contests">Contests</button>
            <button class="tab-btn" data-tab="users">Users</button>
            <button class="tab-btn" data-tab="submissions">Submissions</button>
        </div>

        <!-- OVERVIEW TAB -->
        <div id="overview" class="tab-content active">
            <!-- Statistics Cards -->
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="label">Total Users</div>
                    <div class="value" id="totalUsers">0</div>
                    <div class="change">‚Üë 12% from last week</div>
                </div>
                <div class="stat-card">
                    <div class="label">Active Users (Today)</div>
                    <div class="value" id="activeUsers">0</div>
                    <div class="change">‚Üë 8% from yesterday</div>
                </div>
                <div class="stat-card">
                    <div class="label">Total Problems</div>
                    <div class="value" id="totalProblems">0</div>
                    <div class="change">‚Üë 5 new this week</div>
                </div>
                <div class="stat-card">
                    <div class="label">Total Submissions</div>
                    <div class="value" id="totalSubmissions">0</div>
                    <div class="change" id="acceptanceRate">Acceptance: 0%</div>
                </div>
                <div class="stat-card">
                    <div class="label">Contests</div>
                    <div class="value" id="totalContests">0</div>
                    <div class="change">‚Üë 2 upcoming</div>
                </div>
                <div class="stat-card">
                    <div class="label">Banned Users</div>
                    <div class="value" id="bannedUsers">0</div>
                    <div class="change negative">Active bans</div>
                </div>
            </div>

            <!-- Quick Actions -->
            <div style="margin: 30px 0;">
                <h3 style="margin-bottom: 15px; color: #333;">Quick Actions</h3>
                <div class="action-cards">
                    <a href="problem-editor.html" class="action-btn">
                        <div class="icon">üìù</div>
                        <div class="title">Create Problem</div>
                        <div class="desc">Add new coding problem</div>
                    </a>
                    <a href="contest-creator.html" class="action-btn">
                        <div class="icon">üèÜ</div>
                        <div class="title">Create Contest</div>
                        <div class="desc">Schedule new contest</div>
                    </a>
                    <a href="user-management.html" class="action-btn">
                        <div class="icon">üë•</div>
                        <div class="title">Manage Users</div>
                        <div class="desc">Ban/verify accounts</div>
                    </a>
                    <a href="#" class="action-btn" onclick="downloadReport(event)">
                        <div class="icon">üìä</div>
                        <div class="title">Download Report</div>
                        <div class="desc">Export statistics</div>
                    </a>
                </div>
            </div>

            <!-- Recent Activity -->
            <div class="table-section">
                <h2>üìã Recent Activity</h2>
                <table id="activityTable">
                    <thead>
                        <tr>
                            <th>Timestamp</th>
                            <th>User</th>
                            <th>Action</th>
                            <th>Details</th>
                        </tr>
                    </thead>
                    <tbody id="activityBody">
                        <tr>
                            <td colspan="4" style="text-align: center; color: #999;">Loading activity...</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- Top Performers -->
            <div class="table-section">
                <h2>üåü Top Performers (This Week)</h2>
                <table id="topTable">
                    <thead>
                        <tr>
                            <th>Rank</th>
                            <th>User</th>
                            <th>Problems Solved</th>
                            <th>Points</th>
                            <th>Submissions</th>
                        </tr>
                    </thead>
                    <tbody id="topBody">
                        <tr>
                            <td colspan="5" style="text-align: center; color: #999;">Loading leaderboard...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- PROBLEMS TAB -->
        <div id="problems" class="tab-content">
            <div class="table-section">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2>üìö Problem Management</h2>
                    <a href="problem-editor.html" class="btn">+ Create Problem</a>
                </div>

                <div class="search-box">
                    <input type="text" id="problemSearch" placeholder="Search problems...">
                    <select id="difficultyFilter">
                        <option value="">All Difficulties</option>
                        <option value="Easy">Easy</option>
                        <option value="Medium">Medium</option>
                        <option value="Hard">Hard</option>
                    </select>
                </div>

                <table id="problemsTable">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Title</th>
                            <th>Difficulty</th>
                            <th>Submissions</th>
                            <th>Acceptance</th>
                            <th>Author</th>
                            <th>Created</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="problemsBody">
                        <tr>
                            <td colspan="8" style="text-align: center; color: #999;">Loading problems...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- CONTESTS TAB -->
        <div id="contests" class="tab-content">
            <div class="table-section">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2>üèÜ Contest Management</h2>
                    <a href="contest-creator.html" class="btn">+ Create Contest</a>
                </div>

                <div class="search-box">
                    <input type="text" id="contestSearch" placeholder="Search contests...">
                    <select id="statusFilter">
                        <option value="">All Statuses</option>
                        <option value="upcoming">Upcoming</option>
                        <option value="live">Live</option>
                        <option value="completed">Completed</option>
                    </select>
                </div>

                <table id="contestsTable">
                    <thead>
                        <tr>
                            <th>Title</th>
                            <th>Type</th>
                            <th>Status</th>
                            <th>Participants</th>
                            <th>Start Time</th>
                            <th>End Time</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="contestsBody">
                        <tr>
                            <td colspan="7" style="text-align: center; color: #999;">Loading contests...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- USERS TAB -->
        <div id="users" class="tab-content">
            <div class="table-section">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2>üë• User Management</h2>
                    <button class="btn" onclick="window.location.href='user-management.html'">View All Users</button>
                </div>

                <div class="search-box">
                    <input type="text" id="userSearch" placeholder="Search users...">
                    <select id="roleFilter">
                        <option value="">All Roles</option>
                        <option value="user">User</option>
                        <option value="moderator">Moderator</option>
                        <option value="admin">Admin</option>
                    </select>
                </div>

                <table id="usersTable">
                    <thead>
                        <tr>
                            <th>Username</th>
                            <th>Email</th>
                            <th>Role</th>
                            <th>Status</th>
                            <th>Joined</th>
                            <th>Submissions</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="usersBody">
                        <tr>
                            <td colspan="7" style="text-align: center; color: #999;">Loading users...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- SUBMISSIONS TAB -->
        <div id="submissions" class="tab-content">
            <div class="table-section">
                <h2>üì§ Recent Submissions</h2>

                <div class="search-box">
                    <input type="text" id="submissionSearch" placeholder="Search submissions...">
                    <select id="verdictFilter">
                        <option value="">All Verdicts</option>
                        <option value="Accepted">Accepted ‚úì</option>
                        <option value="Wrong Answer">Wrong Answer ‚úó</option>
                        <option value="Time Limit Exceeded">TLE ‚è±</option>
                        <option value="Runtime Error">RE üí•</option>
                    </select>
                </div>

                <table id="submissionsTable">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>User</th>
                            <th>Problem</th>
                            <th>Language</th>
                            <th>Verdict</th>
                            <th>Time (ms)</th>
                            <th>Memory (MB)</th>
                            <th>Submitted</th>
                        </tr>
                    </thead>
                    <tbody id="submissionsBody">
                        <tr>
                            <td colspan="8" style="text-align: center; color: #999;">Loading submissions...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <div id="confirmModal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeModal('confirmModal')">&times;</span>
            <div class="modal-header">Confirm Action</div>
            <p id="confirmMessage">Are you sure?</p>
            <div style="margin-top: 20px; display: flex; gap: 10px; justify-content: flex-end;">
                <button class="btn secondary" onclick="closeModal('confirmModal')">Cancel</button>
                <button class="btn" id="confirmBtn" onclick="confirmAction()">Confirm</button>
            </div>
        </div>
    </div>

    <script src="../js/api.js"></script>
    <script>
        let currentStats = {};
        let pendingAction = null;

        // Tab switching
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const tabName = this.getAttribute('data-tab');
                switchTab(tabName);
            });
        });

        function switchTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });

            // Show selected tab
            document.getElementById(tabName).classList.add('active');
            document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');

            // Load data for tab
            loadTabData(tabName);
        }

        async function loadTabData(tabName) {
            try {
                if (tabName === 'overview') {
                    await loadStatistics();
                    await loadRecentActivity();
                    await loadTopPerformers();
                } else if (tabName === 'problems') {
                    await loadProblems();
                } else if (tabName === 'contests') {
                    await loadContests();
                } else if (tabName === 'users') {
                    await loadUsers();
                } else if (tabName === 'submissions') {
                    await loadSubmissions();
                }
            } catch (error) {
                console.error('Error loading tab data:', error);
            }
        }

        async function loadStatistics() {
            try {
                const response = await fetch('/api/admin/stats', {
                    headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
                });
                const data = await response.json();

                if (data.success) {
                    const stats = data.data;
                    currentStats = stats;

                    document.getElementById('totalUsers').textContent = stats.usersCount || 0;
                    document.getElementById('activeUsers').textContent = stats.activeUsers || 0;
                    document.getElementById('totalProblems').textContent = stats.problemsCount || 0;
                    document.getElementById('totalSubmissions').textContent = stats.submissionsCount || 0;
                    document.getElementById('totalContests').textContent = stats.contestsCount || 0;
                    document.getElementById('bannedUsers').textContent = stats.bannedCount || 0;
                    document.getElementById('acceptanceRate').textContent = 
                        `Acceptance: ${((stats.acceptanceRate || 0) * 100).toFixed(1)}%`;
                }
            } catch (error) {
                console.error('Error loading statistics:', error);
            }
        }

        async function loadRecentActivity() {
            try {
                const response = await fetch('/api/admin/activity?limit=10', {
                    headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
                });
                const data = await response.json();

                const tbody = document.getElementById('activityBody');
                tbody.innerHTML = '';

                if (data.success && data.data.length > 0) {
                    data.data.forEach(activity => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${new Date(activity.timestamp).toLocaleString()}</td>
                            <td>${activity.user || 'System'}</td>
                            <td>${activity.action}</td>
                            <td>${activity.details}</td>
                        `;
                        tbody.appendChild(row);
                    });
                } else {
                    tbody.innerHTML = '<tr><td colspan="4" style="text-align: center; color: #999;">No recent activity</td></tr>';
                }
            } catch (error) {
                console.error('Error loading activity:', error);
            }
        }

        async function loadTopPerformers() {
            try {
                const response = await fetch('/api/leaderboard?limit=5', {
                    headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
                });
                const data = await response.json();

                const tbody = document.getElementById('topBody');
                tbody.innerHTML = '';

                if (data.success && data.data.length > 0) {
                    data.data.forEach((user, index) => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td><strong>#${index + 1}</strong></td>
                            <td><a href="/user-profile.html?id=${user._id}" style="color: #667eea; text-decoration: none;">${user.username}</a></td>
                            <td>${user.problemsSolved || 0}</td>
                            <td><strong>${user.totalPoints || 0}</strong></td>
                            <td>${user.totalSubmissions || 0}</td>
                        `;
                        tbody.appendChild(row);
                    });
                }
            } catch (error) {
                console.error('Error loading top performers:', error);
            }
        }

        async function loadProblems() {
            try {
                const search = document.getElementById('problemSearch')?.value || '';
                const difficulty = document.getElementById('difficultyFilter')?.value || '';

                let url = '/api/problems?page=1&limit=20';
                if (difficulty) url += `&difficulty=${difficulty}`;
                if (search) url += `&search=${search}`;

                const response = await fetch(url, {
                    headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
                });
                const data = await response.json();

                const tbody = document.getElementById('problemsBody');
                tbody.innerHTML = '';

                if (data.success && data.data.length > 0) {
                    data.data.forEach(problem => {
                        const acceptance = problem.submissions > 0 ? 
                            ((problem.submissionsAccepted / problem.submissions) * 100).toFixed(1) : 0;
                        
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${problem._id.substring(0, 8)}</td>
                            <td><a href="/problem-detail.html?id=${problem._id}" style="color: #667eea; text-decoration: none;">${problem.title}</a></td>
                            <td><span class="badge ${getDifficultyClass(problem.difficulty)}">${problem.difficulty}</span></td>
                            <td>${problem.submissions || 0}</td>
                            <td>${acceptance}%</td>
                            <td>${problem.author?.username || 'Unknown'}</td>
                            <td>${new Date(problem.createdAt).toLocaleDateString()}</td>
                            <td>
                                <div class="action-icons">
                                    <button onclick="editProblem('${problem._id}')" title="Edit">‚úèÔ∏è</button>
                                    <button class="delete" onclick="deleteProblem('${problem._id}')" title="Delete">üóëÔ∏è</button>
                                </div>
                            </td>
                        `;
                        tbody.appendChild(row);
                    });
                } else {
                    tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; color: #999;">No problems found</td></tr>';
                }
            } catch (error) {
                console.error('Error loading problems:', error);
            }
        }

        async function loadContests() {
            try {
                const response = await fetch('/api/contests', {
                    headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
                });
                const data = await response.json();

                const tbody = document.getElementById('contestsBody');
                tbody.innerHTML = '';

                if (data.success && data.data.length > 0) {
                    data.data.forEach(contest => {
                        const status = getContestStatus(contest);
                        const statusColor = status === 'Live' ? 'success' : (status === 'Upcoming' ? 'warning' : 'info');

                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td><a href="/live-contest.html?id=${contest._id}" style="color: #667eea; text-decoration: none;">${contest.title}</a></td>
                            <td>${contest.type || 'Practice'}</td>
                            <td><span class="badge ${statusColor}">${status}</span></td>
                            <td>${contest.participants?.length || 0}</td>
                            <td>${new Date(contest.startTime).toLocaleString()}</td>
                            <td>${new Date(contest.endTime).toLocaleString()}</td>
                            <td>
                                <div class="action-icons">
                                    <button onclick="editContest('${contest._id}')" title="Edit">‚úèÔ∏è</button>
                                    <button class="delete" onclick="deleteContest('${contest._id}')" title="Delete">üóëÔ∏è</button>
                                </div>
                            </td>
                        `;
                        tbody.appendChild(row);
                    });
                }
            } catch (error) {
                console.error('Error loading contests:', error);
            }
        }

        async function loadUsers() {
            try {
                const response = await fetch('/api/admin/users?limit=20', {
                    headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
                });
                const data = await response.json();

                const tbody = document.getElementById('usersBody');
                tbody.innerHTML = '';

                if (data.success && data.data.length > 0) {
                    data.data.forEach(user => {
                        const statusBadge = user.isBanned ? 
                            '<span class="badge danger">Banned</span>' : 
                            '<span class="badge success">Active</span>';

                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td><a href="/user-profile.html?id=${user._id}" style="color: #667eea; text-decoration: none;">${user.username}</a></td>
                            <td>${user.email}</td>
                            <td><span class="badge info">${user.role || 'user'}</span></td>
                            <td>${statusBadge}</td>
                            <td>${new Date(user.createdAt).toLocaleDateString()}</td>
                            <td>${user.totalSubmissions || 0}</td>
                            <td>
                                <div class="action-icons">
                                    <button onclick="viewUser('${user._id}')" title="View">üëÅÔ∏è</button>
                                    ${!user.isBanned ? `<button onclick="banUser('${user._id}', '${user.username}')" title="Ban">üö´</button>` : 
                                      `<button onclick="unbanUser('${user._id}', '${user.username}')" title="Unban">‚úÖ</button>`}
                                </div>
                            </td>
                        `;
                        tbody.appendChild(row);
                    });
                }
            } catch (error) {
                console.error('Error loading users:', error);
            }
        }

        async function loadSubmissions() {
            try {
                const response = await fetch('/api/submissions/user/all?limit=20', {
                    headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
                });
                const data = await response.json();

                const tbody = document.getElementById('submissionsBody');
                tbody.innerHTML = '';

                if (data.success && data.data.length > 0) {
                    data.data.forEach(submission => {
                        const verdictColor = getVerdictColor(submission.verdict);

                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${submission._id.substring(0, 8)}</td>
                            <td>${submission.user?.username || 'Unknown'}</td>
                            <td>${submission.problem?.title || 'Unknown'}</td>
                            <td>${submission.language}</td>
                            <td><span class="badge ${verdictColor}">${submission.verdict}</span></td>
                            <td>${submission.executionTime || 'N/A'}</td>
                            <td>${submission.memory || 'N/A'}</td>
                            <td>${new Date(submission.submittedAt).toLocaleString()}</td>
                        `;
                        tbody.appendChild(row);
                    });
                }
            } catch (error) {
                console.error('Error loading submissions:', error);
            }
        }

        function getDifficultyClass(difficulty) {
            if (difficulty === 'Easy') return 'success';
            if (difficulty === 'Medium') return 'warning';
            return 'danger';
        }

        function getContestStatus(contest) {
            const now = new Date();
            const start = new Date(contest.startTime);
            const end = new Date(contest.endTime);

            if (now < start) return 'Upcoming';
            if (now > end) return 'Completed';
            return 'Live';
        }

        function getVerdictColor(verdict) {
            if (verdict === 'Accepted') return 'success';
            if (verdict === 'Wrong Answer') return 'danger';
            if (verdict === 'Time Limit Exceeded' || verdict === 'Memory Limit Exceeded') return 'warning';
            return 'danger';
        }

        function editProblem(id) {
            window.location.href = `problem-editor.html?edit=${id}`;
        }

        function deleteProblem(id) {
            pendingAction = async () => {
                try {
                    const response = await fetch(`/api/admin/problems/${id}`, {
                        method: 'DELETE',
                        headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
                    });

                    if (response.ok) {
                        alert('Problem deleted successfully');
                        loadProblems();
                    }
                } catch (error) {
                    console.error('Error deleting problem:', error);
                    alert('Failed to delete problem');
                }
            };

            document.getElementById('confirmMessage').textContent = 'Are you sure you want to delete this problem? All associated submissions will also be deleted.';
            document.getElementById('confirmModal').classList.add('active');
        }

        function editContest(id) {
            window.location.href = `contest-creator.html?edit=${id}`;
        }

        function deleteContest(id) {
            pendingAction = async () => {
                try {
                    const response = await fetch(`/api/admin/contests/${id}`, {
                        method: 'DELETE',
                        headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
                    });

                    if (response.ok) {
                        alert('Contest deleted successfully');
                        loadContests();
                    }
                } catch (error) {
                    console.error('Error deleting contest:', error);
                    alert('Failed to delete contest');
                }
            };

            document.getElementById('confirmMessage').textContent = 'Are you sure you want to delete this contest?';
            document.getElementById('confirmModal').classList.add('active');
        }

        function banUser(id, username) {
            const reason = prompt(`Ban user "${username}"? Enter reason:`, '');
            if (!reason) return;

            pendingAction = async () => {
                try {
                    const response = await fetch(`/api/admin/users/${id}/ban`, {
                        method: 'PUT',
                        headers: {
                            'Authorization': `Bearer ${localStorage.getItem('token')}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ reason })
                    });

                    if (response.ok) {
                        alert('User banned successfully');
                        loadUsers();
                    }
                } catch (error) {
                    console.error('Error banning user:', error);
                    alert('Failed to ban user');
                }
            };

            document.getElementById('confirmMessage').textContent = `Ban user '${username}'? Reason: ${reason}`;
            document.getElementById('confirmModal').classList.add('active');
        }

        function unbanUser(id, username) {
            pendingAction = async () => {
                try {
                    const response = await fetch(`/api/admin/users/${id}/unban`, {
                        method: 'PUT',
                        headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
                    });

                    if (response.ok) {
                        alert('User unbanned successfully');
                        loadUsers();
                    }
                } catch (error) {
                    console.error('Error unbanning user:', error);
                    alert('Failed to unban user');
                }
            };

            document.getElementById('confirmMessage').textContent = `Unban user '${username}'?`;
            document.getElementById('confirmModal').classList.add('active');
        }

        function viewUser(id) {
            window.location.href = `/user-profile.html?id=${id}`;
        }

        function downloadReport() {
            // Simple CSV export
            const timestamp = new Date().toISOString().split('T')[0];
            const csv = `
StudyHub Platform Report - ${timestamp}
Total Users,${currentStats.usersCount || 0}
Active Users,${currentStats.activeUsers || 0}
Total Problems,${currentStats.problemsCount || 0}
Total Submissions,${currentStats.submissionsCount || 0}
Acceptance Rate,${((currentStats.acceptanceRate || 0) * 100).toFixed(1)}%
Total Contests,${currentStats.contestsCount || 0}
Banned Users,${currentStats.bannedCount || 0}
            `;
            downloadFile(csv, `admin-report-${timestamp}.csv`);
        }

        function downloadFile(content, filename) {
            const element = document.createElement('a');
            element.setAttribute('href', 'data:text/plain;charset=utf-8,' + encodeURIComponent(content));
            element.setAttribute('download', filename);
            element.style.display = 'none';
            document.body.appendChild(element);
            element.click();
            document.body.removeChild(element);
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }

        function confirmAction() {
            if (pendingAction) {
                pendingAction();
                closeModal('confirmModal');
            }
        }

        // Search and filter handlers
        document.getElementById('problemSearch')?.addEventListener('input', loadProblems);
        document.getElementById('difficultyFilter')?.addEventListener('change', loadProblems);
        document.getElementById('contestSearch')?.addEventListener('input', loadContests);
        document.getElementById('statusFilter')?.addEventListener('change', loadContests);
        document.getElementById('userSearch')?.addEventListener('input', loadUsers);
        document.getElementById('roleFilter')?.addEventListener('change', loadUsers);
        document.getElementById('submissionSearch')?.addEventListener('input', loadSubmissions);
        document.getElementById('verdictFilter')?.addEventListener('change', loadSubmissions);

        // Click outside modal to close
        window.addEventListener('click', function(event) {
            const modal = document.getElementById('confirmModal');
            if (event.target === modal) {
                closeModal('confirmModal');
            }
        });

        // Initial load
        loadTabData('overview');
    </script>
</body>
</html>
